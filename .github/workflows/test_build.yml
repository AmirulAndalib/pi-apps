name: Test_Build

# Controls when the workflow will run
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      name:
        description: 'App Name, PR #, or zip URL'
        required: true
        default: ''
      bullseye:
        description: 'Build on PiOS Bullseye'
        required: true
        type: boolean
      bookworm:
        description: 'Build on PiOS Bookworm'
        required: true
        type: boolean
      trixie:
        description: 'Build on PiOS Trixie (Beta)'
        required: true
        type: boolean
      architecture:
        type: choice
        description: 'For Bullseye/Bookworm, test on 32bit, 64bit, or Both if available'
        options:
        - Both
        - 64bit
        - 32bit
      l4t_jammy_64:
        description: 'Build on Switchroot Ubuntu Jammy 64bit'
        required: true
        type: boolean
      l4t_noble_64:
        description: 'Build on Switchroot Ubuntu Noble 64bit'
        required: true
        type: boolean
      noble_64:
        description: 'Build on RPi Ubuntu Noble 64bit'
        required: true
        type: boolean

run-name: Testing ${{ inputs.name }}

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  bullseye-32bit:
    runs-on: ubuntu-24.04-arm
    if: ${{ inputs.bullseye && ( inputs.architecture == '32bit' || inputs.architecture == 'Both' ) }}
    steps:
      - uses: actions/checkout@v4
      - name: Test installing app on bullseye armhf
        uses: theofficialgman/chroot-runner-action@v0
        with:
          base_image: https://downloads.raspberrypi.org/raspios_oldstable_armhf/images/raspios_oldstable_armhf-2024-07-04/2024-07-04-raspios-bullseye-armhf.img.xz
          bind_mount_repository: yes
          image_additional_mb: 5000
          cpu_info: cpuinfo/raspberrypi_4b
          copy_repository_path: /home/runner/pi-apps
          export_github_env: yes
          import_github_env: true
          shell: /bin/bash
          commands: |
            export name="${{ inputs.name }}"
            ./.github/workflows/test_build_commands.sh

  bookworm-32bit:
    runs-on: ubuntu-24.04-arm
    if: ${{ inputs.bookworm && ( inputs.architecture == '32bit' || inputs.architecture == 'Both' ) }}
    steps:
      - uses: actions/checkout@v4
      - name: Test installing app on bookworm armhf
        uses: theofficialgman/chroot-runner-action@v0
        with:
          base_image: https://downloads.raspberrypi.com/raspios_armhf/images/raspios_armhf-2024-07-04/2024-07-04-raspios-bookworm-armhf.img.xz
          bind_mount_repository: yes
          image_additional_mb: 5000
          cpu_info: cpuinfo/raspberrypi_4b
          copy_repository_path: /home/runner/pi-apps
          export_github_env: yes
          import_github_env: true
          shell: /bin/bash
          commands: |
            export name="${{ inputs.name }}"
            ./.github/workflows/test_build_commands.sh

  trixie-32bit:
    runs-on: ubuntu-24.04-arm
    if: ${{ inputs.trixie && ( inputs.architecture == '32bit' || inputs.architecture == 'Both' ) }}
    steps:
      - uses: actions/checkout@v4
      - name: Test installing app on trixie armhf
        uses: theofficialgman/chroot-runner-action@v0
        with:
          base_image: https://downloads.raspberrypi.com/raspios_armhf/images/raspios_armhf-2025-10-02/2025-10-01-raspios-trixie-armhf.img.xz
          bind_mount_repository: yes
          image_additional_mb: 5000
          cpu_info: cpuinfo/raspberrypi_4b
          copy_repository_path: /home/runner/pi-apps
          export_github_env: yes
          import_github_env: true
          shell: /bin/bash
          commands: |
            export name="${{ inputs.name }}"
            ./.github/workflows/test_build_commands.sh

  bullseye-64bit:
    runs-on: ubuntu-24.04-arm
    if: ${{ inputs.bullseye && ( inputs.architecture == '64bit' || inputs.architecture == 'Both' ) }}
    steps:
      - uses: actions/checkout@v4
      - name: Test installing app on bullseye arm64
        uses: theofficialgman/chroot-runner-action@v0
        with:
          base_image: https://downloads.raspberrypi.org/raspios_oldstable_arm64/images/raspios_oldstable_arm64-2024-07-04/2024-07-04-raspios-bullseye-arm64.img.xz
          bind_mount_repository: yes
          image_additional_mb: 5000
          cpu_info: cpuinfo/raspberrypi_4b
          copy_repository_path: /home/runner/pi-apps
          export_github_env: yes
          import_github_env: true
          shell: /bin/bash
          commands: |
            export name="${{ inputs.name }}"
            ./.github/workflows/test_build_commands.sh

  bookworm-64bit:
    runs-on: ubuntu-24.04-arm
    if: ${{ inputs.bookworm && ( inputs.architecture == '64bit' || inputs.architecture == 'Both' ) }}
    steps:
      - uses: actions/checkout@v4
      - name: Test installing app on bookworm arm64
        uses: theofficialgman/chroot-runner-action@v0
        with:
          base_image: https://downloads.raspberrypi.com/raspios_arm64/images/raspios_arm64-2024-07-04/2024-07-04-raspios-bookworm-arm64.img.xz
          bind_mount_repository: yes
          image_additional_mb: 5000
          cpu_info: cpuinfo/raspberrypi_4b
          copy_repository_path: /home/runner/pi-apps
          export_github_env: yes
          import_github_env: true
          shell: /bin/bash
          commands: |
            export name="${{ inputs.name }}"
            ./.github/workflows/test_build_commands.sh

  trixie-64bit:
    runs-on: ubuntu-24.04-arm
    if: ${{ inputs.trixie }}
    steps:
      - uses: actions/checkout@v4
      - name: Test installing app on trixie arm64
        uses: theofficialgman/chroot-runner-action@v0
        with:
          base_image: https://downloads.raspberrypi.com/raspios_arm64/images/raspios_arm64-2025-10-02/2025-10-01-raspios-trixie-arm64.img.xz
          bind_mount_repository: yes
          image_additional_mb: 5000
          cpu_info: cpuinfo/raspberrypi_4b
          copy_repository_path: /home/runner/pi-apps
          export_github_env: yes
          import_github_env: true
          shell: /bin/bash
          commands: |
            export name="${{ inputs.name }}"
            ./.github/workflows/test_build_commands.sh

  l4t-jammy-64bit:
    runs-on: ubuntu-24.04-arm
    if: ${{ inputs.l4t_jammy_64 }}
    steps:
      - uses: actions/checkout@v4
      - name: Test installing app on L4T jammy arm64
        uses: theofficialgman/chroot-runner-action@v0
        with:
          base_image: https://download.switchroot.org/ubuntu-jammy/theofficialgman-ubuntu-jammy-5.1.2-2025-08-16.7z
          # add special arguments for switchroot image format
          bootpartition:
          rootpartition: 1
          bind_mount_repository: yes
          image_additional_mb: 5000
          copy_repository_path: /home/runner/pi-apps
          export_github_env: yes
          import_github_env: true
          shell: /bin/bash
          commands: |
            export name="${{ inputs.name }}"
            ./.github/workflows/test_build_commands.sh

  l4t-noble-64bit:
    runs-on: ubuntu-24.04-arm
    if: ${{ inputs.l4t_noble_64 }}
    steps:
      - uses: actions/checkout@v4
      - name: Test installing app on L4T noble arm64
        uses: theofficialgman/chroot-runner-action@v0
        with:
          base_image: https://download.switchroot.org/ubuntu-noble/theofficialgman-kubuntu-noble-5.1.2-2025-08-16.7z
          # add special arguments for switchroot image format
          bootpartition:
          rootpartition: 1
          bind_mount_repository: yes
          image_additional_mb: 5000
          copy_repository_path: /home/runner/pi-apps
          export_github_env: yes
          import_github_env: true
          shell: /bin/bash
          commands: |
            export name="${{ inputs.name }}"
            ./.github/workflows/test_build_commands.sh

  noble-64bit:
    runs-on: ubuntu-24.04-arm
    if: ${{ inputs.noble_64 }}
    steps:
      - uses: actions/checkout@v4
      - name: Test installing app on noble arm64
        uses: theofficialgman/chroot-runner-action@v0
        with:
          base_image: https://cdimage.ubuntu.com/releases/24.04/release/ubuntu-24.04.2-preinstalled-desktop-arm64+raspi.img.xz
          bind_mount_repository: yes
          image_additional_mb: 5000
          cpu_info: cpuinfo/raspberrypi_4b
          copy_repository_path: /home/runner/pi-apps
          export_github_env: yes
          import_github_env: true
          shell: /bin/bash
          commands: |
            export name="${{ inputs.name }}"
            ./.github/workflows/test_build_commands.sh
